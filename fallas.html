<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Incidencias corporativo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { background-color: #f3f4f6; font-family: 'Inter', sans-serif; color: #1f2937; }
        
        /* Tarjetas estilo Enterprise */
        .dashboard-card { 
            background: #ffffff; 
            border-radius: 12px; 
            border: 1px solid #e5e7eb; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); 
        }
        
        /* Cabecera corporativa */
        .app-header { background: #111827; color: white; padding: 1rem 0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        /* Scroll interno elegante */
        .desc-scroll {
            max-height: 70px;
            overflow-y: auto;
            font-size: 0.875rem;
            color: #4b5563;
            padding-right: 5px;
        }
        .desc-scroll::-webkit-scrollbar { width: 4px; }
        .desc-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        /* Estados visuales de inputs */
        .form-control:focus, .form-select:focus { box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25); border-color: #3b82f6; }
        
        .priority-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
    </style>
</head>
<body>

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;">
    <div id="liveToast" class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage">Mensaje</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title text-danger fw-bold"><i class="bi bi-exclamation-triangle-fill"></i> Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ¿Estás seguro de que deseas eliminar este registro de forma permanente? Esta acción no se puede deshacer.
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Sí, eliminar</button>
            </div>
        </div>
    </div>
</div>

<header class="app-header mb-5">
    <div class="container d-flex justify-content-between align-items-center">
        <h4 class="mb-0 fw-bold"><i class="bi bi-layers-fill text-primary"></i> TechDesk Ops</h4>
        <span class="badge bg-primary rounded-pill">Portal de Soporte</span>
    </div>
</header>

<div class="container">
    <div class="row g-4">
        <div class="col-xl-4 col-lg-5">
            <div class="dashboard-card p-4">
                <h5 class="fw-bold mb-4" id="formTitle">Nuevo Ticket</h5>
                <form id="incidenciaForm" novalidate>
                    <input type="hidden" id="editIndex" value="-1">
                    
                    <div class="mb-3">
                        <label class="form-label small fw-semibold text-secondary">Usuario Reportante</label>
                        <input type="text" id="nombre" class="form-control" placeholder="Ej: Ana López" required>
                        <div class="invalid-feedback">Ingrese un nombre válido (3-50 letras, sin números).</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-semibold text-secondary">Clasificación</label>
                        <select id="tipo" class="form-select" required>
                            <option value="">Seleccione categoría...</option>
                            <option value="Error">Error Crítico</option>
                            <option value="Falla">Falla de Sistema</option>
                            <option value="Problema">Problema de Usuario</option>
                        </select>
                        <div class="invalid-feedback">Debe seleccionar una categoría.</div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <label class="form-label small fw-semibold text-secondary">Detalle Técnico</label>
                            <span id="charCount" class="text-muted small" style="font-size: 0.75rem;">0/250</span>
                        </div>
                        <textarea id="descripcion" class="form-control" rows="3" maxlength="250" placeholder="Describa el incidente..." required></textarea>
                        <div class="invalid-feedback">La descripción debe tener entre 10 y 250 caracteres válidos.</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label small fw-semibold text-secondary">Nivel de Impacto (1-10)</label>
                        <div class="d-flex align-items-center gap-3">
                            <input type="range" id="prioridad" class="form-range w-100" min="1" max="10" value="1" oninput="document.getElementById('prioValue').innerText = this.value">
                            <span id="prioValue" class="badge bg-dark fs-6 w-25 text-center">1</span>
                        </div>
                    </div>

                    <button type="button" onclick="procesarDatos()" class="btn btn-primary w-100 fw-medium">
                        <i class="bi bi-check2-circle"></i> Guardar Ticket
                    </button>
                    <button type="button" id="btnCancelar" onclick="resetForm()" class="btn btn-outline-secondary w-100 mt-2 d-none">
                        Cancelar Edición
                    </button>
                </form>
            </div>
        </div>

        <div class="col-xl-8 col-lg-7">
            <div class="dashboard-card overflow-hidden">
                <div class="p-3 bg-white border-bottom d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-secondary">TICKETS ACTIVOS</h6>
                    <div class="btn-group shadow-sm">
                        <button class="btn btn-outline-secondary btn-sm" onclick="aplicarOrden('fecha')"><i class="bi bi-clock"></i> Recientes</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="aplicarOrden('prioridad')"><i class="bi bi-sort-down-alt"></i> Prioridad</button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-secondary small">
                            <tr>
                                <th class="ps-4" style="width: 15%;">Estado</th>
                                <th style="width: 25%;">Reportante</th>
                                <th style="width: 45%;">Detalles</th>
                                <th class="text-end pe-4" style="width: 15%;">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="tablaBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let datos = JSON.parse(localStorage.getItem("incidencias_v4")) || [];
    let ordenActual = localStorage.getItem("orden_pref") || 'fecha';
    let idAEliminar = null;

    // Inicializar Modal de Bootstrap y Toasts
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    const toastElement = document.getElementById('liveToast');
    const toast = new bootstrap.Toast(toastElement);

    // Event Listeners
    document.getElementById('descripcion').addEventListener('input', e => {
        document.getElementById('charCount').textContent = `${e.target.value.length}/250`;
    });
    document.getElementById('confirmDeleteBtn').addEventListener('click', ejecutarEliminacion);
    document.addEventListener('DOMContentLoaded', mostrar);

    // Sistema de validación visual
    function validarCampo(inputElement, esValido) {
        if (esValido) {
            inputElement.classList.remove('is-invalid');
            inputElement.classList.add('is-valid');
        } else {
            inputElement.classList.remove('is-valid');
            inputElement.classList.add('is-invalid');
        }
        return esValido;
    }

    function procesarDatos() {
        const index = document.getElementById("editIndex").value;
        const nombreInput = document.getElementById("nombre");
        const tipoInput = document.getElementById("tipo");
        const descInput = document.getElementById("descripcion");
        const prioridadInput = document.getElementById("prioridad");

        const nombre = nombreInput.value.trim();
        const tipo = tipoInput.value;
        const descripcion = descInput.value.trim();
        const prioridad = parseInt(prioridadInput.value);

        // --- VALIDACIONES ESTRICTAS ---
        const vNombre = validarCampo(nombreInput, /^[a-zA-ZÀ-ÿ\s]{3,50}$/.test(nombre));
        
        // Evita manipulación del DOM en el select
        const tiposPermitidos = ["Error", "Falla", "Problema"];
        const vTipo = validarCampo(tipoInput, tiposPermitidos.includes(tipo));
        
        // Evita solo espacios o descripciones vacías/muy cortas
        const vDesc = validarCampo(descInput, descripcion.length >= 10 && descripcion.length <= 250);
        
        if (!vNombre || !vTipo || !vDesc) {
            mostrarToast("Por favor, corrige los errores en el formulario.", "bg-danger");
            return;
        }

        const registro = {
            id: index === "-1" ? Date.now() : datos[index].id, 
            fecha: index === "-1" ? new Date().toISOString() : datos[index].fecha,
            nombre, tipo, descripcion, prioridad
        };

        if (index === "-1") {
            datos.push(registro);
            mostrarToast("Ticket creado exitosamente.", "bg-success");
        } else {
            datos[index] = registro;
            mostrarToast("Ticket actualizado correctamente.", "bg-primary");
        }

        guardarYRefrescar();
        resetForm();
    }

    function mostrar() {
        const tabla = document.getElementById("tablaBody");
        tabla.innerHTML = "";

        if (datos.length === 0) {
            tabla.innerHTML = `<tr><td colspan="4" class="text-center py-5 text-muted"><i class="bi bi-inbox fs-1 d-block mb-2"></i>No hay tickets activos en este momento.</td></tr>`;
            return;
        }

        let datosAMostrar = [...datos];
        if (ordenActual === 'prioridad') {
            datosAMostrar.sort((a, b) => b.prioridad - a.prioridad);
        } else {
            datosAMostrar.sort((a, b) => b.id - a.id); // Más recientes primero
        }

        datosAMostrar.forEach((item) => {
            const indexReal = datos.findIndex(d => d.id === item.id);
            const fechaFormateada = new Date(item.fecha).toLocaleDateString('es-PE', { day: '2-digit', month: 'short', year: 'numeric' });
            
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="ps-4">
                    <div class="d-flex flex-column align-items-center">
                        <span class="priority-dot ${getColor(item.prioridad)} mb-1"></span>
                        <span class="fw-bold fs-5">${item.prioridad}</span>
                        <small class="text-muted" style="font-size: 0.65rem;">Impacto</small>
                    </div>
                </td>
                <td>
                    <div class="fw-semibold text-dark">${escapeHTML(item.nombre)}</div>
                    <span class="badge bg-light text-dark border mt-1">${escapeHTML(item.tipo)}</span>
                </td>
                <td>
                    <div class="text-muted small mb-1"><i class="bi bi-calendar3"></i> ${fechaFormateada}</div>
                    <div class="desc-scroll">${escapeHTML(item.descripcion)}</div>
                </td>
                <td class="text-end pe-4">
                    <button class="btn btn-sm btn-light border text-primary me-1" onclick="prepararEdicion(${indexReal})" title="Editar"><i class="bi bi-pencil-square"></i></button>
                    <button class="btn btn-sm btn-light border text-danger" onclick="confirmarEliminacion(${indexReal})" title="Eliminar"><i class="bi bi-trash3"></i></button>
                </td>
            `;
            tabla.appendChild(tr);
        });
    }

    // Funciones de utilidad y control UI
    function aplicarOrden(metodo) {
        ordenActual = metodo;
        localStorage.setItem("orden_pref", metodo);
        mostrar();
    }

    function confirmarEliminacion(index) {
        idAEliminar = index;
        deleteModal.show();
    }

    function ejecutarEliminacion() {
        if (idAEliminar !== null) {
            datos.splice(idAEliminar, 1);
            guardarYRefrescar();
            deleteModal.hide();
            mostrarToast("Ticket eliminado.", "bg-dark");
            idAEliminar = null;
        }
    }

    function prepararEdicion(index) {
        const item = datos[index];
        document.getElementById("nombre").value = item.nombre;
        document.getElementById("tipo").value = item.tipo;
        document.getElementById("descripcion").value = item.descripcion;
        document.getElementById("prioridad").value = item.prioridad;
        document.getElementById("prioValue").innerText = item.prioridad;
        document.getElementById("editIndex").value = index;
        
        document.getElementById("formTitle").innerText = "Actualizar Ticket";
        document.getElementById("btnCancelar").classList.remove("d-none");
        document.getElementById('charCount').textContent = `${item.descripcion.length}/250`;
        
        // Limpiar validaciones previas
        document.querySelectorAll('.form-control, .form-select').forEach(el => {
            el.classList.remove('is-valid', 'is-invalid');
        });
    }

    function guardarYRefrescar() {
        localStorage.setItem("incidencias_v4", JSON.stringify(datos));
        mostrar();
    }

    function resetForm() {
        document.getElementById("incidenciaForm").reset();
        document.getElementById("editIndex").value = "-1";
        document.getElementById("formTitle").innerText = "Nuevo Ticket";
        document.getElementById("btnCancelar").classList.add("d-none");
        document.getElementById("prioValue").innerText = "1";
        document.getElementById('charCount').textContent = `0/250`;
        
        document.querySelectorAll('.form-control, .form-select').forEach(el => {
            el.classList.remove('is-valid', 'is-invalid');
        });
    }

    function mostrarToast(mensaje, colorClass) {
        const toastEl = document.getElementById('liveToast');
        toastEl.className = `toast align-items-center text-white border-0 ${colorClass}`;
        document.getElementById('toastMessage').innerText = mensaje;
        toast.show();
    }

    function getColor(p) {
        if (p >= 8) return "bg-danger";
        if (p >= 5) return "bg-warning";
        return "bg-success";
    }

    function escapeHTML(str) {
        const p = document.createElement('p');
        p.textContent = str;
        return p.innerHTML;
    }
</script>

</body>
</html>
